<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Effects</title>
    <style>
      #output {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <button onclick="start()" style="overflow: hidden; display: none">
      Play Video
    </button>
    <video id="video" preload="auto" muted playsinline hidden></video>
    <canvas id="output"></canvas>
    <canvas id="buffer" hidden></canvas>

    <script>
      const videoList = [
        "https://cdn.byn.vn/hieuungqua-2115158575-d638665260196388620.mp4",
        "https://cdn.byn.vn/Qua tang phao hoa (2)-1968853805-d638665265169942998.mp4",
      ];
      let currentVideoIndex = 0;
      const DataBlobCache = [];

      async function start() {
        const videoUrl = videoList[currentVideoIndex];
        if (DataBlobCache[videoUrl]) {
          loadVideo(DataBlobCache[videoUrl]);
        } else {
          try {
            const response = await fetch(videoUrl, { mode: "cors" });
            if (!response.ok) {
              console.error("Failed to fetch video:", response.statusText);
              return;
            }
            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);
            DataBlobCache[videoUrl] = objectUrl;
            loadVideo(objectUrl);
          } catch (error) {
            console.error("Error fetching video:", error);
          }
        }
      }

      function loadVideo(videoUrl) {
        const videoElement = document.getElementById("video");
        videoElement.src = videoUrl;

        videoElement.oncanplay = () => {
          setupCanvas();
          videoElement
            .play()
            .catch((err) => console.error("Error playing:", err));
          runVideoEffects();
        };

        videoElement.onended = () => {
          currentVideoIndex = (currentVideoIndex + 1) % videoList.length;
          start();
        };
      }

      function setupCanvas() {
        const videoElement = document.getElementById("video");
        const bufferCanvas = document.getElementById("buffer");
        const outputCanvas = document.getElementById("output");

        bufferCanvas.width = videoElement.videoWidth / 2;
        bufferCanvas.height = videoElement.videoHeight;
        outputCanvas.width = videoElement.videoWidth / 2;
        outputCanvas.height = videoElement.videoHeight;
      }

      function runVideoEffects() {
        const videoElement = document.getElementById("video");
        const bufferCanvas = document.getElementById("buffer");
        const outputCanvas = document.getElementById("output");
        const bufferContext = bufferCanvas.getContext("2d", {
          willReadFrequently: true,
        });
        const outputContext = outputCanvas.getContext("2d");

        function drawFrame() {
          if (!videoElement.paused && videoElement.readyState >= 2) {
            // Xóa sạch bufferCanvas và outputCanvas trước khi vẽ
            // bufferContext.clearRect(
            //   0,
            //   0,
            //   bufferCanvas.width,
            //   bufferCanvas.height
            // );
            outputContext.clearRect(
              0,
              0,
              outputCanvas.width,
              outputCanvas.height
            );

            // Vẽ video lên bufferCanvas (chỉ một nửa video)
            bufferContext.drawImage(
              videoElement,
              videoElement.videoWidth / 2, // Bắt đầu từ nửa chiều rộng
              0,
              videoElement.videoWidth / 2,
              videoElement.videoHeight,
              0,
              0,
              bufferCanvas.width,
              bufferCanvas.height
            );

            const frameData = bufferContext.getImageData(
              0,
              0,
              bufferCanvas.width,
              bufferCanvas.height
            );

            // Điều chỉnh kênh alpha (trong suốt)
            for (let i = 0; i < frameData.data.length; i += 4) {
              frameData.data[i + 3] = frameData.data[i]; // Dùng kênh đỏ làm kênh alpha
            }
            bufferContext.putImageData(frameData, 0, 0);

            // Xóa và vẽ lại nội dung lên outputCanvas
            outputContext.globalCompositeOperation = "source-over";
            outputContext.drawImage(
              bufferCanvas,
              0,
              0,
              outputCanvas.width,
              outputCanvas.height
            );

            // Thiết lập cho chế độ vẽ kết hợp
            outputContext.globalCompositeOperation = "source-atop";
            outputContext.drawImage(
              videoElement,
              0,
              0,
              outputCanvas.width,
              outputCanvas.height
            );

            // Tiếp tục vẽ khung hình tiếp theo
            requestAnimationFrame(drawFrame);
          }
        }

        drawFrame();
      }

      document.addEventListener("DOMContentLoaded", start);
    </script>

    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000;
      }

      #output {
        height: 100%;
        aspect-ratio: 9 / 16;
        max-width: 720px;
        border: 2px solid #fff;
        display: block;
      }
    </style>
  </body>
</html>
