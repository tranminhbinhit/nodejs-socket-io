<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>B test</title>

    <!-- <link
      rel="shortcut icon"
      type="image/x-icon"
      href="https://jqsvn.com/google_tiktok/logo.png"
    /> -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="google" content="notranslate" />
    <link
      rel="stylesheet"
      type="text/css"
      charset="UTF-8"
      href="./css/fonts.css"
    />
    <style>
      body {
        font-family: Oswald, sans-serif;
        margin: 0;
        padding: 0;
      }
    </style>
    <link href="./css/style.css" rel="stylesheet" />
  </head>

  <body>
    <script>
      var display = "0";
      var videoList = [
        "https://cdn.byn.vn/hieuungqua-2115158575-d638665260196388620.mp4", // URL video demo
        "https://cdn.byn.vn/Qua tang phao hoa (2)-1968853805-d638665265169942998.mp4", // URL video demo
      ];
      var currentVideoIndex = 0;
      var DataBlobCache = [];

      async function start() {
        var videoUrl = videoList[currentVideoIndex];

        if (DataBlobCache[videoUrl]) {
          loadVideo(DataBlobCache[videoUrl]);
        } else {
          try {
            const response = await fetch(videoUrl, { mode: "cors" }); // Chế độ CORS
            if (!response.ok) {
              console.error("Failed to fetch video:", response.statusText);
              return;
            }
            const blob = await response.blob();
            const objectUrl = URL.createObjectURL(blob);
            DataBlobCache[videoUrl] = objectUrl; // Cache lại URL blob
            loadVideo(objectUrl);
          } catch (error) {
            console.error("Error fetching video:", error);
          }
        }
      }

      function loadVideo(videoUrl) {
        const videoElement = document.getElementById("video");
        videoElement.src = videoUrl;
        videoElement.addEventListener("loadedmetadata", () => {
          // Đặt kích thước canvas khi video sẵn sàng
          const bufferCanvas = document.getElementById("buffer");
          const outputCanvas = document.getElementById("output");
          // bufferCanvas.width = videoElement.videoWidth / 2;
          // bufferCanvas.height = videoElement.videoHeight;
          // outputCanvas.width = videoElement.videoWidth / 2;
          // outputCanvas.height = videoElement.videoHeight;
          const scaleFactor = 1; // Ví dụ: giảm 50% kích thước
          bufferCanvas.width = videoElement.videoWidth / 2;
          bufferCanvas.height = videoElement.videoHeight;
          outputCanvas.width = videoElement.videoWidth / 2;
          outputCanvas.height = videoElement.videoHeight;

          videoElement.play();
          run_video_effects();
        });

        videoElement.addEventListener("ended", () => {
          currentVideoIndex = (currentVideoIndex + 1) % videoList.length;
          start(); // Phát video tiếp theo khi video hiện tại kết thúc
        });
      }

      function run_video_effects() {
        const videoElement = document.getElementById("video");
        const bufferCanvas = document.getElementById("buffer");
        const outputCanvas = document.getElementById("output");
        const bufferContext = bufferCanvas.getContext("2d", {
          willReadFrequently: true,
        });
        const outputContext = outputCanvas.getContext("2d");

        function drawFrame() {
          if (
            !videoElement.paused &&
            videoElement.videoWidth > 0 &&
            videoElement.videoHeight > 0
          ) {
            bufferContext.drawImage(
              videoElement,
              videoElement.videoWidth / 2,
              0,
              videoElement.videoWidth / 2,
              videoElement.videoHeight,
              0,
              0,
              bufferCanvas.width,
              bufferCanvas.height
            );

            const frameData = bufferContext.getImageData(
              0,
              0,
              bufferCanvas.width,
              bufferCanvas.height
            );
            for (let i = 0; i < frameData.data.length; i += 4) {
              frameData.data[i + 3] = frameData.data[i]; // Adjust alpha
            }
            bufferContext.putImageData(frameData, 0, 0);
            outputContext.clearRect(
              0,
              0,
              outputCanvas.width,
              outputCanvas.height
            );
            outputContext.globalCompositeOperation = "source-over";
            outputContext.drawImage(
              bufferCanvas,
              0,
              0,
              outputCanvas.width,
              outputCanvas.height
            );
            outputContext.globalCompositeOperation = "source-in";
            outputContext.drawImage(
              videoElement,
              0,
              0,
              outputCanvas.width,
              outputCanvas.height
            );

            window.requestAnimationFrame(drawFrame);
          }
        }

        drawFrame();
      }

      document.addEventListener("DOMContentLoaded", start); // Khởi chạy video đầu tiên khi tải trang
    </script>

    <video id="video" preload="" muted="" hidden=""></video>
    <canvas id="output"></canvas>
    <canvas id="buffer" hidden=""></canvas>

    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        display: flex;
        justify-content: center;
        /* Căn giữa theo chiều ngang */
        align-items: center;
        /* Căn giữa theo chiều dọc */
        border: 1px solid red;
      }

      #output {
        width: auto;
        /* Giữ chiều rộng tự động */
        opacity: 0;
        height: 100%;
        /* Chiều cao là 100% */
        aspect-ratio: 9 / 16;
        /* Tỷ lệ 9:16 */
        max-width: 720px;
        /* Tối đa chiều rộng */
      }
      /* #buffer{
        width: 1px;
        display: none;
      } */

      #buffer,
      #output {
        display: block;
      }
    </style>
  </body>
</html>
